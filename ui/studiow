#!/bin/bash
set -e

# This is a wrapper script that runs the specific version of Android Studio that is recommended for developing in this repository.
# (This serves a similar purpose to gradlew)


function getStudioUrl() {
  propertiesFile="${scriptDir}/studio_versions.properties"
  version="$(grep "studio_version=" ${propertiesFile} | sed 's/[^=]*=//')"
  ideaMajorVersion="$(grep "idea_major_version=" ${propertiesFile} | sed 's/[^=]*=//')"
  buildNumber="$(grep "studio_build_number=" ${propertiesFile} | sed 's/[^=]*=//')"
  osName="$1"
  # Trusted server maintained by the Compose team to host internal builds of compose in a maven repository.
  studioUrl="https://us-central1-kompose-219700.cloudfunctions.net/as-r4a/$buildNumber/android-studio-$buildNumber.$osName.zip"
  echo "${studioUrl}"
}

acceptsLicenseAgreement="$1"
scriptDir="$(cd $(dirname $0) && pwd)"
projectDir=$scriptDir
tempDir="${scriptDir}/studio"
function getOsName() {
  unameOutput="$(uname)"
  osName=""
  if [ "${unameOutput}" == "Linux" ]; then
    osName="linux"
  else
    osName="mac"
  fi
  echo "${osName}"
}
osName="$(getOsName)"
studioUrl="$(getStudioUrl $osName)"
studioDestName="$(basename ${studioUrl})"
studioZipPath="${tempDir}/${studioDestName}"
studioUnzippedPath="$(echo ${studioZipPath} | sed 's/\.zip$//')"

function error_exit {
    echo "$1" >&2   ## Send message to stderr.
    exit 1
}

function downloadFile() {
  fromUrl="$1"
  destPath="$2"
  tempPath="${destPath}.tmp"
  r4a_username=$(grep 'r4a_username=' ~/.gradle/gradle.properties | sed 's/^[^=]*=//')
  r4a_password=$(grep 'r4a_password=' ~/.gradle/gradle.properties | sed 's/^[^=]*=//')
  [ -z "$r4a_username" ] && error_exit "r4a_username could not be found in ~/.gradle/gradle.properties.
  [ -z "$r4a_password" ] && error_exit "r4a_password could not be found in ~/.gradle/gradle.properties.
  echo "Downloading ${fromUrl} to ${destPath}"
  curl -L -u $r4a_username:$r4a_password "${fromUrl}" > "${tempPath}"
  mv "${tempPath}" "${destPath}"
}

function findStudioMacAppPath() {
  echo "$(find "${studioUnzippedPath}" -type d -depth 1 -name "Android Studio*.app")"
}

function getLicensePath() {
  if [ "${osName}" == "mac" ]; then
    appPath="$(findStudioMacAppPath)"
    echo "${appPath}/Contents/Resources/LICENSE.txt"
  else
    echo "${studioUnzippedPath}/android-studio/LICENSE.txt"
  fi
}

function checkLicenseAgreement() {
  # TODO: Is there a more official way to check that the user accepts the license?

  licenseAcceptedPath="${studioUnzippedPath}/STUDIOW_LICENSE_ACCEPTED"

  if [ ! -f "${licenseAcceptedPath}" ]; then
    if [ "${acceptsLicenseAgreement}" == "-y" ]; then
      touch "${licenseAcceptedPath}"
    else
      read -r -n 1 -p "Do you accept the license agreement at $(getLicensePath) [Y/n]? " reply

      if [ ! -z "${reply}" ]; then
	# Fix missing newline
        echo
      fi

      case "${reply}" in
        [yY]|"")
          touch "${licenseAcceptedPath}"
          ;;
        *)
          exit 1
          ;;
      esac
    fi
  fi
}

function updateStudio() {
  # skip if already up-to-date
  if stat "${studioUnzippedPath}" >/dev/null 2>/dev/null; then
    # already up-to-date
    return
  fi

  mkdir -p "${tempDir}"
  downloadFile "${studioUrl}" "${studioZipPath}"
  echo

  echo "Removing previous installations"
  ls "${tempDir}" | grep -v "^${studioDestName}\$" | sed "s|^|${tempDir}/|" | xargs rm -rf

  echo "Unzipping"
  unzip "${studioZipPath}" -d "${studioUnzippedPath}"
}

function ensureComposeAt() {
  pluginPath=$1
  copyOption=$2
  idePluginJar="$pluginPath/r4a-ide-plugin.jar"
  compilerPluginJar="$pluginPath/r4a-compiler-plugin.jar"
  compilerPluginJarOutput="../../../out/ui/compose-plugin-cli/build/libs/compose-plugin-cli-1.0.0-alpha01.jar"
  idePluginJarOutput="../../../out/ui/compose-plugin-ide/build/libs/compose-plugin-ide-1.0.0-alpha01.jar"
  if [ ! -e "$idePluginJarOutput" ] || [ ! -e "$compilerPluginJarOutput" ]
  then
    echo "Building compose plugin"
    ./gradlew :compose-plugin-ide:assemble :compose-plugin-cli:ideVersion
  fi
  cp $copyOption "$compilerPluginJarOutput" "$compilerPluginJar"
  cp $copyOption "$idePluginJarOutput" "$idePluginJar"
}

function ensureComposeLinux() {
  ensureComposeAt "${studioUnzippedPath}/android-studio/plugins/Kotlin/lib" "-u"
}

function ensureComposeMac() {
  ensureComposeAt "$(findStudioMacAppPath)/Contents/plugins/Kotlin/lib"
}

function ensureCompose() {
  # ensure compose plugin is up-to-date
  if [ "${osName}" == "mac" ]; then
    ensureComposeMac
  else
    ensureComposeLinux
  fi
}

function runStudioLinux() {
  studioPath="${studioUnzippedPath}/android-studio/bin/studio.sh"
  echo "$studioPath &"
  env STUDIO_PROPERTIES="${projectDir}/../development/studio/idea.properties" \
      STUDIO_VM_OPTIONS="${projectDir}/../development/studio/studio.vmoptions" \
      KOTLIN_OVERRIDE="1.3.30-compose-20190503" \
      "${studioPath}" "${projectDir}" &
}

function runStudioMac() {
  appPath="$(findStudioMacAppPath)"
  echo "open ${appPath}"
  env STUDIO_PROPERTIES="${projectDir}/../development/studio/idea.properties" \
      STUDIO_VM_OPTIONS="${projectDir}/../development/studio/studio.vmoptions" \
      KOTLIN_OVERRIDE="1.3.30-compose-20190503" \
      open -a "${appPath}" "${projectDir}"
}

function runStudio() {
  if [ "${osName}" == "mac" ]; then
    runStudioMac
  else
    runStudioLinux
  fi
}

function main() {
  updateStudio
  ensureCompose
  checkLicenseAgreement
  runStudio
}

main
